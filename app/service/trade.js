const request = require('superagent');

const mock = {
    btc: [[1510329600000,"6797","6933.51","6145.6","6249.77","2594.86109498"],[1510416000000,"6225.07","6460.38","5100","6175.31","5035.04158462"],[1510502400000,"6174.59","6689.91","5590.46","6586.99","2515.6"],[1510588800000,"6586.99","6656.63","6180.61","6459.57","1972.9"],[1510675200000,"6459.57","7249.91","6427.52","7235","1779.30993402"],[1510761600000,"7235","7546.5","7080.02","7480","3185.08659532"],[1510848000000,"7480","8020.25","7401.68","7953.29","3365.95368752"],[1510934400000,"7953.29","7989.17","7450.01","7695.51","3327.9371866"],[1511020800000,"7704.69","7875.93","7623.11","7745.1","1496.4941044"],[1511107200000,"7745.1","8248.68","7727.95","8184.56","2526.38584668"],[1511193600000,"8185.48","8392.44","7854.61","8370.16","2412.74663546"],[1511280000000,"8374.62","8406.31","8121.86","8273","1931.0543346"],[1511366400000,"8273","8405","8120","8255","1988.38020718"],[1511452800000,"8256.65","8499","7981","8131.03","5623.77972372"],[1511539200000,"8131.58","8620","8077.06","8581.36","3330.7619868"],[1511625600000,"8581.36","9078.99","8559.18","9057.15","3443.8989801"],[1511712000000,"9057.16","9710.99","9031.63","9575.49","6002.25870756"],[1511798400000,"9575.81","9988.75","9398.31","9830.43","16271.49507788"],[1511884800000,"9830.43","11308.12","9778.33","10810.99","10564.14271354"],[1511971200000,"10810.9","10997.43","8900","9133.15","28242.77719896"],[1512057600000,"9133.15","10671.52","9097.49","10482.78","22079.51817318"],[1512144000000,"10482.79","11199.6","10368.04","10706.04","26090.38011986"],[1512230400000,"10706.03","11770.4401","10706.03","11727.48","15530.68430484"],[1512316800000,"11727.5402","11800","10522","11306.6","9552.34867756"],[1512403200000,"11305.96","11900.0109","11109.23","11776.61","6031.43975042"],[1512489600000,"11776.6101","12880","11574.98","12476.78","7674.33518018"],[1512576000000,"12476.78","15552.49","12338.38","15465.9799","13074.15820574"],[1512662400000,"15465.9799","17387.78","14004.055","15400","18180.3714651"],[1512748800000,"15400","16249.25","14111","14422.08","11518.89966648"],[1512835200000,"14422.08","15557.97","12750.0099","15361.51","16975.31425758"],[1512921600000,"15361.5101","16573.92","14386.0001","16332.819","11662.95834106"],[1513008000000,"16323.11","17500","15511","16068.11","14319.98455176"],[1513094400000,"16068.1299","16704.45","15076.3301","15917.5","10999.56586042"],[1513180800000,"15917.5","16355","15271.5001","15907.07","8780.23514748"],[1513267200000,"15907.07","17992.352","15792.03","17457.26","9319.3512909"],[1513353600000,"17450.6738","18867.9899","16997.0101","18856.7901","7623.05500746"],[1513440000000,"18856.79","19821.98","18441.1401","19200.0699","7110.26762932"],[1513526400000,"19200.0699","19414.86","17700.72","18679.3513","10738.25781162"],[1513612800000,"18679.3803","18823.99","18125.11","18713.688","4620.90623874"]],
    qtum: [[1510329600000,"11.37","11.77","10.1","11.49","33208.908"],[1510416000000,"11.05","11.74","9.83","11.7","114296.212"],[1510502400000,"11.7","12.23","10.65","11.25","55020.928"],[1510588800000,"11.24","11.68","11","11.43","44831.958"],[1510675200000,"11.43","11.78","11.32","11.78","41697.3784783"],[1510761600000,"11.78","13.51","11.49","12.97","201696.9857038"],[1510848000000,"12.95","13.46","12.34","12.95","165156.27725386"],[1510934400000,"12.95","14.19","12.81","13.76","113184.07641554"],[1511020800000,"13.73","14.19","13.39","13.79","89397.4812945"],[1511107200000,"13.8","14.79","13.5","14.73","106221.8763367"],[1511193600000,"14.73","15.2","13","14.45","99570.79022098"],[1511280000000,"14.45","14.5","13.42","13.88","72778.46724812"],[1511366400000,"13.88","14.16","13.54","14.08","58363.39817984"],[1511452800000,"14.08","14.19","13.29","13.76","89649.065112"],[1511539200000,"13.76","14.67","13.72","14.61","125650.65879238"],[1511625600000,"14.61","14.75","13.97","14.53","99337.10694446"],[1511712000000,"14.53","14.88","13.76","14.5","144275.83810884"],[1511798400000,"14.45","16.17","13.95","14.5","303112.4348014"],[1511884800000,"14.5","14.64","13.29","14.01","248831.00956928"],[1511971200000,"13.97","13.99","10.69","11.01","234157.32803076"],[1512057600000,"11.01","12.6","11.01","12.17","47419.7220984"],[1512144000000,"12.2","12.94","12.15","12.4","64969.93912248"],[1512230400000,"12.4","13.4501","12.4","13.32","65493.16653804"],[1512316800000,"13.32","13.48","12","12.988","79699.23153664"],[1512403200000,"12.988","13.6901","12.72","12.72","92255.60104954"],[1512489600000,"12.7105","12.7105","11.6204","11.83","91510.73998922"],[1512576000000,"11.8303","13.9986","10.6","11.1","142389.00384406"],[1512662400000,"11.1","11.68","10.3","11.36","85415.66570754"],[1512748800000,"11.36","12.23","11.2216","11.6118","81317.17157834"],[1512835200000,"11.6899","11.8902","10.4","11.361","117421.77183508"],[1512921600000,"11.361","14.65","10.42","12.67","128526.56189332"],[1513008000000,"12.69","13.53","12.15","13.1349","112471.09074584"],[1513094400000,"13.1353","17.59","12","16.37","233756.8214997"],[1513180800000,"16.36","18.27","14","17.14","115787.1295154"],[1513267200000,"17.14","21.59","15.71","21","133316.62941388"],[1513353600000,"21","29.27","14","26.6199","383995.07760026"],[1513440000000,"26.6199","29.7192","25","28.2","105687.85747772"],[1513526400000,"28.2001","44.8","25.2901","42.53","264132.77205162"],[1513612800000,"43.22","69.4398","40.1231","63.8366","179035.83218532"]]
};

const date = (timestamp) => {
    const d = new Date(timestamp);
    return `${d.getMonth() + 1}/${d.getDate()}`;
};

module.exports = app => {
    class Trade extends app.Service {
        async kline(symbol, type) {
            const { helper: { settings } } = this.ctx;
            const url = settings.urls.okex.kline(symbol, type);
            const _res = await new Promise(resolve =>
                request
                    .get(url)
                    .end((err, res) => {
                        resolve(res && res.ok ? res.body : err);
                    })
            );
            console.log(_res);
            const uni = {};
            mock.btc.forEach((item) => {
                const d = date(item[0]);
                if (!uni[d]) {
                    uni[d] = {
                        btc: 0,
                        qtum: 0
                    };
                }
                uni[d].btc = item[4];
            });
            mock.qtum.forEach((item) => {
                const d = date(item[0]);
                if (!uni[d]) {
                    uni[d] = {
                        btc: 0,
                        qtum: 0
                    };
                }
                uni[d].qtum = item[4];
            });
            const res = Object.keys(uni).map(key => ({
                name: key,
                btc: +uni[key].btc,
                qtum: +uni[key].qtum * 1000
            }));
            return this.ctx.helper.resWrap(res);
        }
    }
    return Trade;
};
